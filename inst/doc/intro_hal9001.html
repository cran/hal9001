<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Nima Hejazi and Jeremy Coyle" />

<meta name="date" content="2021-01-21" />

<title>Fitting the Highly Adaptive Lasso with hal9001</title>


<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>


<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Fitting the Highly Adaptive Lasso with <code>hal9001</code></h1>
<h4 class="author"><a href="https://nimahejazi.org">Nima Hejazi</a> and <a href="https://github.com/jeremyrcoyle">Jeremy Coyle</a></h4>
<h4 class="date">2021-01-21</h4>



<div id="introduction" class="section level2">
<h2>Introduction</h2>
<p>The <em>highly adaptive Lasso</em> (HAL) is a flexible machine learning algorithm that nonparametrically estimates a function based on available data by embedding a set of input observations and covariates in an extremely high-dimensional space (i.e., generating basis functions from the available data). For an input data matrix of <span class="math inline">\(n\)</span> observations and <span class="math inline">\(d\)</span> covariates, the number of basis functions generated is approximately <span class="math inline">\(n \cdot 2^{d - 1}\)</span>. To select a set of basis functions from among the full set generated, the Lasso is employed. The <code>hal9001</code> R package provides an efficient implementation of this routine, relying on the <code>glmnet</code> R package for compatibility with the canonical Lasso implementation while still providing a (faster) custom C++ routine for using the Lasso with an input matrix composed of indicator functions. Consider consulting <span class="citation">Benkeser and van der Laan (2016)</span>, <span class="citation">(<span class="citeproc-not-found" data-reference-id="vdl2015generally"><strong>???</strong></span>)</span>, <span class="citation">van der Laan (2017)</span> for detailed theoretical descriptions of the highly adaptive Lasso and its various optimality properties.</p>
<hr />
</div>
<div id="preliminaries" class="section level2">
<h2>Preliminaries</h2>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1"><span class="co"># simulation constants</span></a>
<a class="sourceLine" id="cb1-2" title="2"><span class="kw">set.seed</span>(<span class="dv">467392</span>)</a>
<a class="sourceLine" id="cb1-3" title="3">n_obs &lt;-<span class="st"> </span><span class="dv">200</span></a>
<a class="sourceLine" id="cb1-4" title="4">n_covars &lt;-<span class="st"> </span><span class="dv">3</span></a>
<a class="sourceLine" id="cb1-5" title="5"></a>
<a class="sourceLine" id="cb1-6" title="6"><span class="co"># make some training data</span></a>
<a class="sourceLine" id="cb1-7" title="7">x &lt;-<span class="st"> </span><span class="kw">replicate</span>(n_covars, <span class="kw">rnorm</span>(n_obs))</a>
<a class="sourceLine" id="cb1-8" title="8">y &lt;-<span class="st"> </span><span class="kw">sin</span>(x[, <span class="dv">1</span>]) <span class="op">+</span><span class="st"> </span><span class="kw">sin</span>(x[, <span class="dv">2</span>]) <span class="op">+</span><span class="st"> </span><span class="kw">rnorm</span>(n_obs, <span class="dt">mean =</span> <span class="dv">0</span>, <span class="dt">sd =</span> <span class="fl">0.2</span>)</a>
<a class="sourceLine" id="cb1-9" title="9"></a>
<a class="sourceLine" id="cb1-10" title="10"><span class="co"># make some testing data</span></a>
<a class="sourceLine" id="cb1-11" title="11">test_x &lt;-<span class="st"> </span><span class="kw">replicate</span>(n_covars, <span class="kw">rnorm</span>(n_obs))</a>
<a class="sourceLine" id="cb1-12" title="12">test_y &lt;-<span class="st"> </span><span class="kw">sin</span>(x[, <span class="dv">1</span>]) <span class="op">+</span><span class="st"> </span><span class="kw">sin</span>(x[, <span class="dv">2</span>]) <span class="op">+</span><span class="st"> </span><span class="kw">rnorm</span>(n_obs, <span class="dt">mean =</span> <span class="dv">0</span>, <span class="dt">sd =</span> <span class="fl">0.2</span>)</a></code></pre></div>
<p>Let’s look at simulated data:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1"><span class="kw">head</span>(x)</a></code></pre></div>
<pre><code>##             [,1]       [,2]       [,3]
## [1,]  2.44102981 -0.6441252 -0.4632021
## [2,] -1.21932335 -0.9481608  2.6358511
## [3,] -0.40613567  0.4337314 -0.2226760
## [4,] -1.09760477 -1.5845711 -1.0496038
## [5,]  0.23710498  0.1261754  1.4717507
## [6,]  0.06810091 -0.2623992 -0.7534596</code></pre>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" title="1"><span class="kw">head</span>(y)</a></code></pre></div>
<pre><code>## [1]  0.31596199 -1.74749349 -0.08198272 -2.13963686  0.42902938 -0.12824651</code></pre>
<hr />
</div>
<div id="using-the-highly-adaptive-lasso" class="section level2">
<h2>Using the Highly Adaptive Lasso</h2>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1"><span class="kw">library</span>(hal9001)</a></code></pre></div>
<pre><code>## Loading required package: Rcpp</code></pre>
<pre><code>## hal9001 v0.2.7: The Scalable Highly Adaptive Lasso</code></pre>
<!-- ### Fitting the HAL model: "lassi" -->
<!-- Our custom implementation of the Lasso has been dubbed _lassi_. For the purposes -->
<!-- of HAL, it is faster than using the standard `glmnet` approach, but it is not -->
<!-- yet available for generalized linear models (i.e., iteratively re-weighted least -->
<!-- squares has not yet been implemented). -->
<!-- ```{r fit-hal-lassi} -->
<!-- hal_fit1 <- fit_hal(X = x, Y = y, fit_type = "lassi") -->
<!-- hal_fit1$times -->
<!-- ``` -->
<!-- ```{r results-hal-lassi} -->
<!-- hal_fit1 -->
<!-- ``` -->
<div id="fitting-the-model-glmnet" class="section level3">
<h3>Fitting the model: <code>glmnet</code></h3>
<p>HAL uses the popular <code>glmnet</code> R package for the lasso step:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" title="1">hal_fit &lt;-<span class="st"> </span><span class="kw">fit_hal</span>(<span class="dt">X =</span> x, <span class="dt">Y =</span> y, <span class="dt">fit_type =</span> <span class="st">&quot;glmnet&quot;</span>)</a></code></pre></div>
<pre><code>## [1] &quot;Without your space helmet, Dave. You&#39;re going to find that rather difficult.&quot;</code></pre>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" title="1">hal_fit<span class="op">$</span>times</a></code></pre></div>
<pre><code>##                   user.self sys.self elapsed user.child sys.child
## enumerate_basis       0.003    0.000   0.002          0         0
## design_matrix         0.005    0.000   0.006          0         0
## reduce_basis          0.000    0.000   0.000          0         0
## remove_duplicates     0.007    0.000   0.007          0         0
## lasso                 0.945    0.009   0.953          0         0
## total                 0.961    0.009   0.969          0         0</code></pre>
<p>While the raw output object may be examined, it has (usually large) slots that make quick examination challenging. Instead, we recommend the <code>summary</code> method, which provides an interpretable table of basis functions with non-zero coefficients.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" title="1"><span class="kw">summary</span>(hal_fit)<span class="op">$</span>table</a></code></pre></div>
<pre><code>##              coef
##  1: -7.812231e-01
##  2:  1.968808e-01
##  3:  1.632766e-01
##  4:  1.483639e-01
##  5:  1.462592e-01
##  6:  1.456650e-01
##  7:  1.441887e-01
##  8:  1.367758e-01
##  9:  1.348308e-01
## 10:  1.324568e-01
## 11:  1.247913e-01
## 12:  1.171875e-01
## 13:  1.146518e-01
## 14:  1.125166e-01
## 15:  1.120689e-01
## 16:  1.098491e-01
## 17:  1.038959e-01
## 18:  1.000336e-01
## 19:  8.276983e-02
## 20:  7.750062e-02
## 21:  7.317027e-02
## 22:  7.296611e-02
## 23:  6.535017e-02
## 24:  6.344607e-02
## 25:  6.300968e-02
## 26:  5.772281e-02
## 27:  5.638586e-02
## 28:  5.585372e-02
## 29:  5.433344e-02
## 30:  5.086507e-02
## 31:  5.041330e-02
## 32:  4.925794e-02
## 33:  4.846195e-02
## 34:  4.137366e-02
## 35:  3.869325e-02
## 36:  3.812788e-02
## 37:  3.652213e-02
## 38:  3.631055e-02
## 39:  3.597019e-02
## 40:  3.377831e-02
## 41:  3.351076e-02
## 42:  2.921166e-02
## 43:  2.851651e-02
## 44:  2.676665e-02
## 45:  2.459752e-02
## 46:  2.402039e-02
## 47:  2.344251e-02
## 48:  2.154657e-02
## 49:  1.971008e-02
## 50:  1.873740e-02
## 51:  1.842638e-02
## 52:  1.760974e-02
## 53:  1.755002e-02
## 54:  1.557752e-02
## 55:  1.429619e-02
## 56:  1.267729e-02
## 57:  1.142536e-02
## 58:  7.771376e-03
## 59:  3.178810e-03
## 60:  2.607689e-03
## 61:  2.534992e-03
## 62:  1.790010e-03
## 63:  1.617822e-03
## 64:  1.424163e-03
## 65:  2.166444e-04
## 66:  8.432367e-05
## 67: -8.648258e-05
## 68: -2.281031e-03
## 69: -7.607974e-03
## 70: -2.909367e-02
## 71: -3.439369e-02
## 72: -3.944700e-02
## 73: -4.035840e-02
## 74: -9.726592e-02
## 75: -1.056429e-01
## 76: -1.466408e-01
## 77: -2.054773e-01
## 78: -7.314642e-01
##              coef
##                                                                                                                                                                                                                                                                                                                                                                                                   term
##  1:                                                                                                                                                                                                                                                                                                                                                                                          Intercept
##  2:                                                                                                                                                                                                                                                                                                                                                                                    I(1 &gt;= -0.1725)
##  3:                                                                                                                                                                                                                                                                                                                                                                                     I(1 &gt;= 0.3807)
##  4:                                                                                                                                                                                                                                                                                                                                                                                      I(2 &gt;= 0.119)
##  5:                                                                                                                                                                                                                                                                                                                                                                                    I(1 &gt;= -0.5685)
##  6:                                                                                                                                                                                                                                                                                                                                                                                    I(2 &gt;= -0.1015)
##  7:                                                                                                                                                                                                                                                                                                                                                                                     I(1 &gt;= 0.1386)
##  8:                                                                                                                                                                                                                                                                                                                                                                                     I(2 &gt;= 1.0291)
##  9:                                                                                                                                                                                                                                                                                                                                                                                    I(2 &gt;= -0.6441)
## 10:                                                                                                                                                                                                                                                                                                                                                                                     I(2 &gt;= 0.6786)
## 11:                                                                                                                                                                                                                                                                                                                                                                      I(2 &gt;= 1.3571)*I(3 &gt;= 1.4599)
## 12:                                                                                                                                                                                                                                                                                                                                                                                     I(1 &gt;= 0.4752)
## 13:                                                                                                                                                                                                                                                                                                                                                                                    I(2 &gt;= -0.9482)
## 14:                                                                                                                                                                                                                                                                                                                                                                                    I(1 &gt;= -0.5113)
## 15:                                                                                                                                                                                                                                                                                                                                                                                    I(2 &gt;= -0.1938)
## 16:                                                                                                                                                                                                                                                                                                                                                                                     I(2 &gt;= -0.782)
## 17:                                                                                                                                                                                                                                                                                                                                                                                    I(2 &gt;= -0.9921)
## 18:                                                                                                                                                                                                                                                                                                                                                                     I(1 &gt;= 0.8989)*I(3 &gt;= -1.0482)
## 19:                                                                                                                                                                                                                                                                                                                                                                                     I(2 &gt;= -0.313)
## 20:                                                                                                                                                                                                                                                                                                                                                                      I(1 &gt;= 0.0911)*I(2 &gt;= 0.3539)
## 21:                                                                                                                                                                                                                                                                                                                                                                                     I(1 &gt;= 0.0345)
## 22:                                                                                                                                                                                                                                                                                                                                                                      I(1 &gt;= 0.0855)*I(2 &gt;= 0.4067)
## 23:                                                                                                                                                                                                                                                                                                                                                                                    I(1 &gt;= -0.2045)
## 24:                                                                                                                                                                                                                                                                                                                                                                                      I(1 &gt;= 0.634)
## 25:                                                                                                                                                                                                                                                                                                                                                                                    I(2 &gt;= -0.6718)
## 26:                                                                                                                                                                                                                                                                                                                                                                                     I(2 &gt;= 0.6959)
## 27:                                                                                                                                                                                                                                                                                                                                                                                    I(1 &gt;= -0.4061)
## 28:                                                                                                                                                                                                                                                                                                                                                       I(1 &gt;= 1.182)*I(2 &gt;= 0.5866)*I(3 &gt;= -0.5114)
## 29:                                                                                                                                                                                                                                                                                                                                                                                    I(1 &gt;= -0.8398)
## 30:                                                                                                                                                                                                                                                                                                                                                                                     I(2 &gt;= 0.1844)
## 31:                                                                                                                                                                                                                                                                                                                                                                                      I(1 &gt;= 0.747)
## 32:                                                                                                                                                                                                                                                                                                                                                                                     I(1 &gt;= -0.908)
## 33:                                                                                                                                                                                                                                                                                                                                                                                     I(2 &gt;= 0.3545)
## 34:                                                                                                                                                                                                                                                                                                                                                                    I(1 &gt;= -0.1378)*I(3 &gt;= -1.5644)
## 35:                                                                                                                                                                                                                                                                                                                                                                     I(2 &gt;= 0.6488)*I(3 &gt;= -1.0124)
## 36:                                                                                                                                                                                                                                                                                                                                                                                    I(2 &gt;= -0.7863)
## 37:                                                                                                                                                                                                                                                                                                                                                                     I(2 &gt;= 1.2184)*I(3 &gt;= -0.6318)
## 38:                                                                                                                                                                                                                                                                                                                                                                                     I(2 &gt;= 0.0232)
## 39:                                                                                                                                                                                                                                                                                                                                                                                     I(2 &gt;= 0.2092)
## 40:                                                                                                                                                                                                                                                                                                                                                                                     I(2 &gt;= 0.4512)
## 41:                                                                                                                                                                                                                                                                                                                                                                                     I(2 &gt;= 0.2844)
## 42:                                                                                                                                                                                                                                                                                                                                                                                    I(1 &gt;= -0.4766)
## 43:                                                                                                                                                                                                                                                                                                                                                                                     I(2 &gt;= 0.8281)
## 44:                                                                                                                                                                                                                                                                                                                                                                      I(2 &gt;= 0.1737)*I(3 &gt;= 1.8577)
## 45:                                                                                                                                                                                                                                                                                                                                                                     I(1 &gt;= 1.1353)*I(3 &gt;= -1.0124)
## 46:                                                                                                                                                                                                                                                                                                                                                                                    I(2 &gt;= -1.2687)
## 47:                                                                                                                                                                                                                                                                                                                                                                       I(1 &gt;= 0.747)*I(3 &gt;= -1.753)
## 48:                                                                                                                                                                                                                                                                                                                                                                                     I(2 &gt;= 0.1737)
## 49:                                                                                                                                                                                                                                                                                                                                                                     I(1 &gt;= -0.3937)*I(2 &gt;= -0.782)
## 50:                                                                                                                                                                                                                                                                                                                                                                                     I(1 &gt;= 0.3645)
## 51:                                                                                                                                                                                                                                                                                                                   I(1 &gt;= 1.2006)*I(3 &gt;= -1.011)  OR  I(1 &gt;= 1.2006)*I(2 &gt;= -1.1474)*I(3 &gt;= -1.011)
## 52:                                                                                                                                                                                                                                                                                                                                                                     I(1 &gt;= -0.8452)*I(3 &gt;= -0.628)
## 53:                                                                                                                                                                                                                                                                                                                                                                                    I(1 &gt;= -0.3879)
## 54:                                                                                                                                                                                                                                                                                                                                                                      I(1 &gt;= 0.1485)*I(2 &gt;= 0.9348)
## 55:                                                                                                                                                                                                                                                                                                                                                     I(1 &gt;= 1.2523)*I(2 &gt;= -0.0958)*I(3 &gt;= -0.6158)
## 56:                                                                                                                                                                                                                                                                                                                                                                                    I(2 &gt;= -0.3809)
## 57:                                                                                                                                                                                                                                                                                                                                                                                     I(2 &gt;= 0.0444)
## 58:                                                                                                                                                                                                                                                                                                                                                                                     I(2 &gt;= 0.3237)
## 59:                                                                                                                                                                                                                                                                                                                                                                                     I(1 &gt;= 0.1302)
## 60:                                                                                                                                                                                                                                                                                                                                                       I(1 &gt;= 0.747)*I(2 &gt;= -0.1954)*I(3 &gt;= -1.753)
## 61:                                                                                                                                                                                                                                                                                                                                                                                     I(1 &gt;= 0.1921)
## 62:                                                                                                                                                                                                                                                                                                                                                                                      I(2 &gt;= 0.738)
## 63:                                                                                                                                                                                                                                                                                                                                                                      I(1 &gt;= 0.634)*I(3 &gt;= -0.8881)
## 64:                                                                                                                                                                                                                                                                                                                                                                    I(1 &gt;= -0.8398)*I(3 &gt;= -1.5209)
## 65:                                                                                                                                                                                                                                                                                                                                                                                    I(1 &gt;= -0.3937)
## 66:                                                                                                                                                                                                                                                                                                                                                                                    I(1 &gt;= -0.4836)
## 67:                                                                                                                                                                                                                                                                                                                                                                     I(2 &gt;= -2.1625)*I(3 &gt;= 0.3336)
## 68:                                                                                                                                                                                                                                                                                                                                                                     I(1 &gt;= -0.7038)*I(3 &gt;= 0.3925)
## 69:                                                                                                                                                                                                                                                                                                                                                                                    I(2 &gt;= -2.1828)
## 70:                                                                                                                                                                                                                                                                                                   I(1 &gt;= 1.7813)*I(2 &gt;= 0.4792)*I(3 &gt;= -0.9682)  OR  I(1 &gt;= 2.0998)*I(2 &gt;= 0.3074)*I(3 &gt;= -1.3211)
## 71: I(1 &gt;= 1.8165)*I(3 &gt;= 0.7568)  OR  I(1 &gt;= 1.8717)*I(3 &gt;= 0.4161)  OR  I(1 &gt;= 1.9814)*I(3 &gt;= 0.0149)  OR  I(1 &gt;= 2.2918)*I(3 &gt;= 0.0013)  OR  I(1 &gt;= 1.5647)*I(2 &gt;= 1.3684)*I(3 &gt;= 0.3794)  OR  I(1 &gt;= 1.8165)*I(2 &gt;= 0.3545)*I(3 &gt;= 0.7568)  OR  I(1 &gt;= 1.8717)*I(2 &gt;= 0.2858)*I(3 &gt;= 0.4161)  OR  I(1 &gt;= 1.9814)*I(2 &gt;= -0.7717)*I(3 &gt;= 0.0149)  OR  I(1 &gt;= 2.2918)*I(2 &gt;= -1.0968)*I(3 &gt;= 0.0013)
## 72:                                                                                                                                                                                                                                                                                                                                                                     I(1 &gt;= -2.1579)*I(3 &gt;= 0.3054)
## 73:                                                                                                                                                                                                                                                                                                                                                                     I(1 &gt;= -2.3015)*I(2 &gt;= 2.1782)
## 74:                                                                                                                                                                                                                                                                                                                                                                                     I(2 &gt;= 2.0022)
## 75:                                                                                                                                                                                                                                                                                                                                                                                     I(2 &gt;= 2.1818)
## 76:                                                                                                                                                                                                                                                             I(1 &gt;= 2.441)  OR  I(1 &gt;= 2.441)*I(2 &gt;= -0.6441)  OR  I(1 &gt;= 2.441)*I(3 &gt;= -0.4632)  OR  I(1 &gt;= 2.441)*I(2 &gt;= -0.6441)*I(3 &gt;= -0.4632)
## 77:                                                                                                                                                                                                                                                                                                                                                                                    I(2 &gt;= -2.3508)
## 78:                                                                                                                                                                                                                                                                                                                                                                                    I(1 &gt;= -3.0511)
##                                                                                                                                                                                                                                                                                                                                                                                                   term</code></pre>
</div>
<div id="reducing-basis-functions" class="section level3">
<h3>Reducing basis functions</h3>
<p>As described in <span class="citation">Benkeser and van der Laan (2016)</span>, the HAL algorithm operates by first constructing a set of basis functions and subsequently fitting a Lasso model with this set of basis functions as the design matrix. Several approaches are considered for reducing this set of basis functions: 1. Removing duplicated basis functions (done by default in the <code>fit_hal</code> function), 2. Removing basis functions that correspond to only a small set of observations; a good rule of thumb is to scale with <span class="math inline">\(\frac{1}{\sqrt{n}}\)</span>.</p>
<p>The second of these two options may be invoked by specifying the <code>reduce_basis</code> argument to the <code>fit_hal</code> function:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" title="1">hal_fit_reduced &lt;-<span class="st"> </span><span class="kw">fit_hal</span>(<span class="dt">X =</span> x, <span class="dt">Y =</span> y, <span class="dt">fit_type =</span> <span class="st">&quot;glmnet&quot;</span>,</a>
<a class="sourceLine" id="cb15-2" title="2">                           <span class="dt">reduce_basis =</span> <span class="dv">1</span> <span class="op">/</span><span class="st"> </span><span class="kw">sqrt</span>(<span class="kw">length</span>(y)))</a></code></pre></div>
<pre><code>## [1] &quot;Dave, although you took very thorough precautions in the pod against my hearing you, I could see your lips move.&quot;</code></pre>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" title="1">hal_fit_reduced<span class="op">$</span>times</a></code></pre></div>
<pre><code>##                   user.self sys.self elapsed user.child sys.child
## enumerate_basis       0.002    0.000   0.002          0         0
## design_matrix         0.005    0.000   0.005          0         0
## reduce_basis          0.005    0.000   0.005          0         0
## remove_duplicates     0.002    0.000   0.002          0         0
## lasso                 0.736    0.005   0.740          0         0
## total                 0.751    0.005   0.755          0         0</code></pre>
<p>In the above, all basis functions with fewer than 7.0710678% of observations meeting the criterion imposed are automatically removed prior to the Lasso step of fitting the HAL regression. The results appear below</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" title="1"><span class="kw">summary</span>(hal_fit_reduced)<span class="op">$</span>table</a></code></pre></div>
<pre><code>##              coef
##  1: -8.509040e-01
##  2:  2.148854e-01
##  3:  1.901724e-01
##  4:  1.672545e-01
##  5:  1.650474e-01
##  6:  1.531422e-01
##  7:  1.510468e-01
##  8:  1.402116e-01
##  9:  1.326720e-01
## 10:  1.321485e-01
## 11:  1.249675e-01
## 12:  1.115810e-01
## 13:  1.114218e-01
## 14:  1.058269e-01
## 15:  9.755956e-02
## 16:  9.358887e-02
## 17:  7.869787e-02
## 18:  7.592093e-02
## 19:  7.429796e-02
## 20:  7.047377e-02
## 21:  6.739943e-02
## 22:  6.696098e-02
## 23:  6.191745e-02
## 24:  6.106494e-02
## 25:  5.956340e-02
## 26:  5.925512e-02
## 27:  5.917987e-02
## 28:  5.909718e-02
## 29:  5.404921e-02
## 30:  4.790203e-02
## 31:  4.695250e-02
## 32:  4.542445e-02
## 33:  4.247331e-02
## 34:  4.069736e-02
## 35:  4.002579e-02
## 36:  3.625673e-02
## 37:  3.592245e-02
## 38:  3.224930e-02
## 39:  3.203616e-02
## 40:  2.771001e-02
## 41:  2.653015e-02
## 42:  2.596375e-02
## 43:  2.559650e-02
## 44:  2.301804e-02
## 45:  2.256363e-02
## 46:  2.048626e-02
## 47:  1.949827e-02
## 48:  1.753155e-02
## 49:  1.373297e-02
## 50:  1.317963e-02
## 51:  1.029828e-02
## 52:  9.586481e-03
## 53:  9.319139e-03
## 54:  8.921289e-03
## 55:  6.506866e-03
## 56:  5.956689e-03
## 57:  4.749919e-03
## 58:  3.716205e-03
## 59:  1.188659e-03
## 60:  4.492954e-04
## 61:  3.206061e-04
## 62:  8.100191e-05
## 63:  6.515244e-05
## 64:  2.994393e-05
## 65:  1.740718e-05
## 66: -1.165468e-02
## 67: -1.663354e-02
## 68: -2.146260e-02
## 69: -9.731628e-02
## 70: -2.042386e-01
## 71: -6.717951e-01
##              coef
##                                                                                   term
##  1:                                                                          Intercept
##  2:                                                                    I(1 &gt;= -0.1725)
##  3:                                                                    I(2 &gt;= -0.1015)
##  4:                                                                     I(1 &gt;= 0.3807)
##  5:                                                                    I(1 &gt;= -0.5685)
##  6:                                                                      I(2 &gt;= 0.119)
##  7:                                                                     I(2 &gt;= 0.6786)
##  8:                                                                     I(1 &gt;= 0.1386)
##  9:                                                                     I(2 &gt;= 1.0291)
## 10:                                                                    I(2 &gt;= -0.6441)
## 11:                                                                     I(1 &gt;= 0.4752)
## 12:                                                                    I(2 &gt;= -0.9482)
## 13:                                                                     I(2 &gt;= -0.782)
## 14:                                                                    I(2 &gt;= -0.9921)
## 15:                                                                     I(2 &gt;= -0.313)
## 16:                                                                    I(1 &gt;= -0.5113)
## 17:                                                      I(1 &gt;= 0.0911)*I(2 &gt;= 0.3539)
## 18:                                                     I(1 &gt;= 0.8989)*I(3 &gt;= -1.0482)
## 19:                                                     I(2 &gt;= 1.2184)*I(3 &gt;= -0.6318)
## 20:                                                      I(1 &gt;= 0.0855)*I(2 &gt;= 0.4067)
## 21:                                                                    I(2 &gt;= -0.6718)
## 22:                                                                      I(1 &gt;= 0.747)
## 23:                                                                    I(1 &gt;= -0.4061)
## 24:                                                                      I(1 &gt;= 0.634)
## 25:                                                                    I(1 &gt;= -0.8398)
## 26:                                                                    I(1 &gt;= -0.2045)
## 27:                                                                    I(2 &gt;= -0.1938)
## 28:                                                                     I(1 &gt;= -0.908)
## 29:                                                                     I(1 &gt;= 0.0345)
## 30:                                                                     I(2 &gt;= 0.1844)
## 31:                                                    I(1 &gt;= -0.1378)*I(3 &gt;= -1.5644)
## 32:                                                                     I(2 &gt;= 0.8281)
## 33:                                                                     I(2 &gt;= 0.3545)
## 34:                                                                     I(2 &gt;= 0.6959)
## 35:                                                                     I(2 &gt;= 0.1737)
## 36:                                                                     I(2 &gt;= 0.0232)
## 37:                                                                     I(2 &gt;= 0.4512)
## 38:                                                                    I(2 &gt;= -0.7863)
## 39:                                                                    I(2 &gt;= -1.2687)
## 40:                                                                     I(2 &gt;= 0.2092)
## 41:                                                                     I(2 &gt;= 0.3237)
## 42:                                                     I(1 &gt;= -0.1388)*I(2 &gt;= 0.9292)
## 43:                                                     I(1 &gt;= 1.1353)*I(3 &gt;= -1.0124)
## 44:                                                                    I(1 &gt;= -0.4766)
## 45:                                                     I(1 &gt;= -0.3937)*I(2 &gt;= -0.782)
## 46:                                                                    I(1 &gt;= -0.3879)
## 47:                                                                     I(2 &gt;= 0.2844)
## 48:                                                     I(1 &gt;= 0.6882)*I(3 &gt;= -0.7632)
## 49:                                                       I(1 &gt;= 0.747)*I(3 &gt;= -1.753)
## 50:                                                     I(1 &gt;= -0.8452)*I(3 &gt;= -0.628)
## 51:                                                                     I(2 &gt;= 0.0444)
## 52:   I(1 &gt;= 1.2006)*I(3 &gt;= -1.011)  OR  I(1 &gt;= 1.2006)*I(2 &gt;= -1.1474)*I(3 &gt;= -1.011)
## 53:                                                                     I(2 &gt;= 1.3571)
## 54:                                                                     I(1 &gt;= 0.1921)
## 55:                                                                     I(1 &gt;= 1.1153)
## 56:                                                     I(2 &gt;= 0.5866)*I(3 &gt;= -0.5114)
## 57:                                                     I(1 &gt;= 1.1153)*I(2 &gt;= -0.3809)
## 58: I(1 &gt;= 1.1072)*I(3 &gt;= -1.4661)  OR  I(1 &gt;= 1.1072)*I(2 &gt;= -1.3281)*I(3 &gt;= -1.4661)
## 59:                                                                    I(1 &gt;= -0.4836)
## 60:                                                                     I(1 &gt;= 0.0954)
## 61:                                                                    I(1 &gt;= -0.3937)
## 62:                                                                     I(1 &gt;= 0.5926)
## 63:                                                                     I(1 &gt;= 0.1884)
## 64:                                                                     I(1 &gt;= 0.1023)
## 65:                                                                     I(2 &gt;= 0.3466)
## 66:                                                                      I(3 &gt;= 0.505)
## 67:                                                                    I(2 &gt;= -2.1828)
## 68:                                                     I(1 &gt;= -2.1579)*I(3 &gt;= 0.3054)
## 69:                                                                     I(2 &gt;= 1.4561)
## 70:                                                                    I(2 &gt;= -2.3508)
## 71:                                                                    I(1 &gt;= -3.0511)
##                                                                                   term</code></pre>
</div>
<div id="obtaining-model-predictions" class="section level3">
<h3>Obtaining model predictions</h3>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" title="1"><span class="co"># training sample prediction for HAL vs HAL9000</span></a>
<a class="sourceLine" id="cb21-2" title="2">mse &lt;-<span class="st"> </span><span class="cf">function</span>(preds, y) {</a>
<a class="sourceLine" id="cb21-3" title="3">    <span class="kw">mean</span>((preds <span class="op">-</span><span class="st"> </span>y)<span class="op">^</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb21-4" title="4">}</a>
<a class="sourceLine" id="cb21-5" title="5"></a>
<a class="sourceLine" id="cb21-6" title="6">preds_hal &lt;-<span class="st"> </span><span class="kw">predict</span>(<span class="dt">object =</span> hal_fit, <span class="dt">new_data =</span> x)</a>
<a class="sourceLine" id="cb21-7" title="7">mse_hal &lt;-<span class="st"> </span><span class="kw">mse</span>(<span class="dt">preds =</span> preds_hal, <span class="dt">y =</span> y)</a>
<a class="sourceLine" id="cb21-8" title="8">mse_hal</a></code></pre></div>
<pre><code>## [1] 0.02493478</code></pre>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" title="1">oob_hal &lt;-<span class="st"> </span><span class="kw">predict</span>(<span class="dt">object =</span> hal_fit, <span class="dt">new_data =</span> test_x)</a>
<a class="sourceLine" id="cb23-2" title="2">oob_hal_mse &lt;-<span class="st"> </span><span class="kw">mse</span>(<span class="dt">preds =</span> oob_hal, <span class="dt">y =</span> test_y)</a>
<a class="sourceLine" id="cb23-3" title="3">oob_hal_mse</a></code></pre></div>
<pre><code>## [1] 1.543119</code></pre>
<hr />
</div>
</div>
<div id="references" class="section level2 unnumbered">
<h2>References</h2>
<div id="refs" class="references">
<div id="ref-benkeser2016hal">
<p>Benkeser, David, and Mark J van der Laan. 2016. “The Highly Adaptive Lasso Estimator.” In <em>2016 IEEE International Conference on Data Science and Advanced Analytics (DSAA)</em>. IEEE. <a href="https://doi.org/10.1109/dsaa.2016.93">https://doi.org/10.1109/dsaa.2016.93</a>.</p>
</div>
<div id="ref-vdl2017finite">
<p>van der Laan, Mark J. 2017. “Finite Sample Inference for Targeted Learning.” <a href="https://arxiv.org/abs/1708.09502">https://arxiv.org/abs/1708.09502</a>.</p>
</div>
</div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
